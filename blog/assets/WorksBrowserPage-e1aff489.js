import{y as ye,c as B,r as p,d as Ie,a as he,ak as ge,b as Te,u as Ee,al as Ae,o as Ce,am as Se,e as be,an as ae,ao as le,a7 as Le,O as L,ap as u,a2 as De,f as _,g as G,h as D,i as a,w as n,j as A,F as M,l as H,L as Ne,A as C,E as k,V as Ve,X as q,Y,aq as ne,ar as P,a6 as $,B as h,m as xe,v as Oe,p as We,s as Ge,q as Pe,S as Be,as as ze,$ as Ue,P as Ke,Q as Re,x as Fe,at as Me,_ as He}from"./index-31ea285c.js";/* empty css                  *//* empty css                   *//* empty css                 *//* empty css               *//* empty css                  *//* empty css                     */import{u as qe}from"./CommonStore-3b205a9f.js";import{g as ie,c as Ye,G as $e,_ as je}from"./Gossip-0cda7023.js";/* empty css               *//* empty css                */import{B as Qe}from"./index-88ad1515.js";import"./wordCloud-ea69ab72.js";import{_ as Xe}from"./DirectoryTreeView.vue_vue_type_script_setup_true_lang-e94846a2.js";import{E as S}from"./DirectroyTree-a29405c1.js";import{w as ce,m as Je}from"./Works-8a0f93c5.js";import{U as Ze}from"./UserInfoView-50e51eba.js";import{c as ue}from"./Collection-6161e28c.js";import{r as N}from"./Watch-ede47acc.js";import{m as et}from"./EchartsUtils-1234ec81.js";import"./DomUtils-6f7af2dc.js";/* empty css                  */import"./install-7b032135.js";import"./el-tree-04aa848f.js";/* empty css                    *//* empty css                   */const tt=ye("worksBrowserStore",()=>{const b=B([]),v=B([]),y=p(),z=1e3*60,I=p(0);return{worksList:b,dirList:v,dirInfo:y,loadWorksAndWorksDirectories:async()=>new Date().getTime()-I.value<z?{worksList:b,dirList:v,dirInfo:y.value}:await ce.listDirectoryAndWorks(null,!0).then(w=>(b.splice(0,b.length,...w.worksList),v.splice(0,v.length,...w.dirList),y.value=w.dirInfo,I.value=new Date().getTime(),w))}}),ot=Ie({__name:"WorksBrowserPage",setup(b){const v=he(),y=ge(),z=tt(),I=Te(),m=Ee(),g=qe(),w=p(!1),V=p(!1),U=p(!1),x=p(!1),T=p(null),de=p([{cmd:S.TO_EDIT,icoName:"el-icon-delete",label:"编辑"},{cmd:S.COPY_LINK,icoName:"el-icon-plus",label:"复制链接"}]),pe=p({searchType:"kw",searchTypes:[{label:"关键字",value:"kw"}],tags:[],orderKeys:[{label:"文件名",value:"fileName"},{label:"创建时间",value:"createTime"}]}),d=B({visible:!1,groups:[],currentGroup:null}),me=(o,e,l)=>{var s,i;switch(console.log(o,e,l),o){case S.NODE_CLICK:e&&(T.value=e,Q(e.id));break;case S.NODE_RIGHT_CLICK:T.value=e;break;case S.COPY_LINK:(s=T.value)!=null&&s.id&&(Ve(window.location.origin+"/#/worksbrowser?worksId="+T.value.id),k.success("复制成功"));break;case S.TO_EDIT:k.info("loading..."),(i=T.value)!=null&&i.id?v.push(`/worksedit?worksId=${T.value.id}`):v.push("/worksedit");break}};Ae([()=>w.value,()=>V.value],([o,e])=>{m.isHidden=o||e});const j=o=>{var l,s;const{cmd:e}=o;switch(e){case u.GOSSIP:w.value=!0;break;case u.DATA_ANALYSIS:V.value=!0;break;case u.CONTENT:U.value=!0;break;case u.LIKE:if(!r.works)return;q.putRecordWorks(r.works.id,Y.ARTICLE,ne.LIKE).then(i=>{k.success("点赞成功"),r.like=!0});break;case u.COLLECTION:if(!r.works)return;ue.listCollectionGroup().then(i=>{i.splice(0,0,{id:null,groupKey:"default"}),d.groups=i,d.currentGroup=i[0].id,d.visible=!0});break;case u.USER_INFO:if(!r.works)return;N.isWatched((s=(l=r.works)==null?void 0:l.userInfo)==null?void 0:s.id).then(i=>{console.log("watched",i),x.value=!!i,F.value=!0});break;case u.EDIT:v.push("/worksedit");break}},r=B({works:null,gossips:[],contentArray:[],topGossipInputValue:"",like:!1}),Q=o=>{ce.queryOne(o).then(e=>{if(e.userId!==I.userInfo.id&&!L.includes([P.ADMIN,P.STAFF],I.userInfo.role)&&(!e.approved||!e.setting.isPublic)){k.error("无法访问该文章");return}r.works=e,q.getHistoryWorksStatistics(o).then(l=>{const s={view:[],like:[],collection:[]};for(let i of l)s.view.push({date:$(i.historyCreateTime).format("yyyy-MM-DD HH"),value:i.viewNum}),s.like.push({date:$(i.historyCreateTime).format("yyyy-MM-DD HH"),value:i.likeNum}),s.collection.push({date:$(i.historyCreateTime).format("yyyy-MM-DD HH"),value:i.collectionNum});s.访问量=s.view,s.点赞量=s.like,s.收藏量=s.collection,delete s.view,delete s.like,delete s.collection,Z.value=et("近期访问数据",s)}),K(o),ee()})},K=o=>{ie.listAllGossip(o).then(e=>{L.includes([P.ADMIN,P.STAFF],I.userInfo.role)||e.forEach(l=>{l.approved||(l.content="评论暂为通过审核")}),r.gossips=Ye(e.map(l=>new $e(l)))})},X=o=>{o?Q(o):z.loadWorksAndWorksDirectories().then(e=>{r.contentArray=Je(e.worksList,e.dirList)})},R=(o,e,l)=>{var s;l=l.replace(/ +/g," ").replace(/[\n\r]+/g,`
`),l!==""&&ie.putGossip(Y.ARTICLE,(s=r.works)==null?void 0:s.id,l,o,e).then(i=>{var f;K((f=r.works)==null?void 0:f.id),k.success("发送成功")}).catch(i=>{k.error("发送失败")})},J=o=>{q.putRecordWorks(o.id,Y.GOSSIP,ne.LIKE).then(e=>{k.success("点赞成功"),K(o.worksId)})},F=p(!1),fe=()=>{var o,e;console.log(d.currentGroup),(o=r.works)!=null&&o.id&&ue.putCollection((e=r.works)==null?void 0:e.id,d.currentGroup??void 0).then(l=>{k.success("收藏成功")}).finally(()=>{d.visible=!1})},ke=(o,e)=>{var l,s;(s=(l=r.works)==null?void 0:l.userInfo)!=null&&s.id&&(e?N.putWatch(o).then(i=>{var f,c;k.success("关注成功"),N.isWatched((c=(f=r.works)==null?void 0:f.userInfo)==null?void 0:c.id).then(E=>{x.value=E})}):N.deleteWatch(o).then(i=>{var f,c;k.success("取消关注成功"),N.isWatched((c=(f=r.works)==null?void 0:f.userInfo)==null?void 0:c.id).then(E=>{x.value=E})}))},Z=p({}),ee=()=>{var l;const o=y.query.worksId,e=[];o||e.push({eventArg:u.CONTENT,iconType:h.CONTENT}),I.token&&e.push({eventArg:u.EDIT,iconType:h.EDIT}),(l=r.works)!=null&&l.id&&e.push({eventArg:u.GOSSIP,iconType:h.GOSSIP},{eventArg:u.DATA_ANALYSIS,iconType:h.DATA},{eventArg:u.LIKE,iconType:h.LIKE},{eventArg:u.COLLECTION,iconType:h.COLLECTION},{eventArg:u.USER_INFO,iconType:h.USER_INFO}),m.switchPage(e)};return Ce(()=>{ee();const o=y.query.worksId;X(o)}),Se(()=>{m.switchPage([])}),be(()=>{const o=y.query.worksId;ae.on(le.NAV_BALL_CLICKED,j),X(o)}),Le(()=>{const o=L.findIndex(m.data,s=>s.eventArg===u.CONTENT);o!==-1&&m.data.splice(o,1);const e=L.findIndex(m.data,s=>s.eventArg===u.DATA_ANALYSIS);e!==-1&&m.data.splice(e,1);const l=L.findIndex(m.data,s=>s.eventArg===u.GOSSIP);l!==-1&&m.data.splice(l,1),ae.off(le.NAV_BALL_CLICKED,j)}),(o,e)=>{const l=De("v-md-preview"),s=Me,i=xe,f=Oe,c=We,E=Ge,te=Pe,oe=je,se=Be,O=ze,W=Ue,we=Ke,_e=Re,ve=Fe;return _(),G("div",null,[r.works?(_(),D(l,{key:0,class:"works-browser-content",text:r.works.content,source:r.works.content},null,8,["text","source"])):(_(),D(s,{key:1,description:"文章不存在啊"})),a(O,{style:{"z-index":"1100"},size:C(g).isPortrait?"70%":"40%",direction:C(g).isPortrait?"btt":"rtl",modelValue:w.value,"onUpdate:modelValue":e[2]||(e[2]=t=>w.value=t)},{header:n(()=>[a(i,{size:"large"},{default:n(()=>[A("评论区")]),_:1})]),default:n(()=>[a(se,null,{default:n(()=>[a(te,{justify:"space-between"},{default:n(()=>[a(c,{span:20},{default:n(()=>[a(f,{modelValue:r.topGossipInputValue,"onUpdate:modelValue":e[0]||(e[0]=t=>r.topGossipInputValue=t),maxlength:"200",placeholder:"Please input","show-word-limit":"",type:"textarea"},null,8,["modelValue"])]),_:1}),a(c,{span:4},{default:n(()=>[a(E,{type:"text",onClick:e[1]||(e[1]=t=>R(null,null,r.topGossipInputValue))},{default:n(()=>[A("Send ")]),_:1})]),_:1})]),_:1}),(_(!0),G(M,null,H(r.gossips,t=>(_(),D(oe,{key:t.id,data:t,onSend:R,onLike:J},Ne({_:2},[t.children.length?{name:"default",fn:n(()=>[(_(!0),G(M,null,H(t.children,re=>(_(),D(oe,{key:re.id,data:re,onSend:R,onLike:J},null,8,["data"]))),128))]),key:"0"}:void 0]),1032,["data"]))),128))]),_:1})]),_:1},8,["size","direction","modelValue"]),a(O,{style:{"z-index":"1100"},size:C(g).isPortrait?"70%":"40%",direction:C(g).isPortrait?"btt":"rtl",modelValue:V.value,"onUpdate:modelValue":e[3]||(e[3]=t=>V.value=t)},{header:n(()=>[a(i,{size:"large"},{default:n(()=>[A("数据分析")]),_:1})]),default:n(()=>[a(se,null,{default:n(()=>[a(te,{align:"middle"},{default:n(()=>[a(c,{span:8},{default:n(()=>{var t;return[a(W,{class:"works-browser-text-center",title:"访问量",value:(t=r.works)==null?void 0:t.statistics.viewNum},null,8,["value"])]}),_:1}),a(c,{span:8},{default:n(()=>{var t;return[a(W,{class:"works-browser-text-center",title:"收藏人数",value:(t=r.works)==null?void 0:t.statistics.collectionNum},null,8,["value"])]}),_:1}),a(c,{span:8},{default:n(()=>{var t;return[a(W,{class:"works-browser-text-center",title:"点赞人数",value:(t=r.works)==null?void 0:t.statistics.likeNum},null,8,["value"])]}),_:1}),a(c,{span:8},{default:n(()=>{var t;return[a(W,{class:"works-browser-text-center",title:"评论数",value:(t=r.works)==null?void 0:t.statistics.gossipNum},null,8,["value"])]}),_:1})]),_:1}),a(C(Qe),{class:"chart",option:Z.value,autoresize:""},null,8,["option"])]),_:1})]),_:1},8,["size","direction","modelValue"]),a(O,{style:{"z-index":"1100"},size:C(g).isPortrait?"70%":"40%",direction:"ltr",modelValue:U.value,"onUpdate:modelValue":e[4]||(e[4]=t=>U.value=t)},{header:n(()=>[a(i,{size:"large"},{default:n(()=>[A("目录")]),_:1})]),default:n(()=>[a(Xe,{height:"100%",onCommand:me,"content-menu-data":de.value,data:r.contentArray,"search-data":pe.value},null,8,["content-menu-data","data","search-data"])]),_:1},8,["size","modelValue"]),a(O,{style:{"z-index":"1100"},size:"400px",direction:"ltr",modelValue:F.value,"onUpdate:modelValue":e[5]||(e[5]=t=>F.value=t)},{header:n(()=>[a(i,{size:"large"},{default:n(()=>[A("作者信息")]),_:1})]),default:n(()=>{var t;return[a(Ze,{type:"detail",onWatch:ke,user:(t=r.works)==null?void 0:t.userInfo,watched:x.value},null,8,["user","watched"])]}),_:1},8,["modelValue"]),a(ve,{modelValue:d.visible,"onUpdate:modelValue":e[7]||(e[7]=t=>d.visible=t),title:"收藏",width:"500"},{footer:n(()=>[a(E,{type:"primary",onClick:fe},{default:n(()=>[A(" Confirm ")]),_:1})]),default:n(()=>[a(_e,{modelValue:d.currentGroup,"onUpdate:modelValue":e[6]||(e[6]=t=>d.currentGroup=t),placeholder:"Select",size:"large",style:{width:"240px"}},{default:n(()=>[(_(!0),G(M,null,H(d.groups,t=>(_(),D(we,{key:t.id,label:t.groupKey,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])])}}});const Lt=He(ot,[["__scopeId","data-v-6f18106f"]]);export{Lt as default};
