var Ce=Object.defineProperty;var Se=(T,m,p)=>m in T?Ce(T,m,{enumerable:!0,configurable:!0,writable:!0,value:p}):T[m]=p;var ie=(T,m,p)=>(Se(T,typeof m!="symbol"?m+"":m,p),p);import{d as pe,K as Le,c as C,r as I,f as h,g as H,F as J,l as le,h as P,w as s,j as L,t as ve,aw as Pe,A as S,v as fe,ax as Ae,aj as Re,s as _e,au as Me,O as be,u as Oe,b as Ue,T as U,o as ze,am as Be,e as Fe,an as ne,ao as re,a7 as Ne,a2 as ue,z as Q,i as a,k as ce,D as We,L as He,E as _,U as Ke,ap as j,a6 as Ye,B as de,ay as $e,az as qe,S as Ge,aA as je,aB as Je,as as Qe,m as Xe,p as Ze,ai as et,q as tt,x as lt,ac as at,ad as st,ae as ot}from"./index-31ea285c.js";/* empty css                     *//* empty css                  *//* empty css                  *//* empty css                   *//* empty css                 *//* empty css               *//* empty css                  *//* empty css                */import{u as it}from"./CommonStore-3b205a9f.js";import"./wordCloud-ea69ab72.js";import{_ as nt}from"./DirectoryTreeView.vue_vue_type_script_setup_true_lang-e94846a2.js";import{S as rt}from"./SplitPanelLayout-ade48211.js";import{D as ut,E as u}from"./DirectroyTree-a29405c1.js";import{w as v,m as me,c as ct}from"./Works-8a0f93c5.js";import{D as dt}from"./DialogBox-32bd50d6.js";import{c as te}from"./Cos-0001a053.js";/* empty css               */import"./DomUtils-6f7af2dc.js";import"./install-7b032135.js";import"./el-tree-04aa848f.js";/* empty css                    *//* empty css                  */const mt={class:"editable-tag-array.container"},pt=pe({__name:"EditableTagArray",props:{tags:{}},emits:["update:tags"],setup(T,{emit:m}){const p=T,X=m,V=Le({get(){return p.tags},set(y){X("update:tags",y)}}),c=C({tagInputValue:"",tagInputVisible:!1}),A=I(),R=()=>{const y=c.tagInputValue;y&&V.value.indexOf(y)===-1&&(V.value=[...V.value,y],console.log("hi",V.value,y)),c.tagInputVisible=!1,c.tagInputValue=""},n=y=>{V.value.indexOf(y)>-1&&(V.value=V.value.filter(k=>k!==y))},f=()=>{c.tagInputVisible=!0,Ae(()=>{A.value.input.focus()})};return(y,z)=>{const k=Re,o=_e;return h(),H("div",mt,[(h(!0),H(J,null,le(V.value,b=>(h(),P(k,{key:b,closable:"","disable-transitions":!1,onClose:d=>n(b)},{default:s(()=>[L(ve(b),1)]),_:2},1032,["onClose"]))),128)),c.tagInputVisible?(h(),P(S(fe),{key:0,ref_key:"InputRef",ref:A,modelValue:c.tagInputValue,"onUpdate:modelValue":z[0]||(z[0]=b=>c.tagInputValue=b),style:{"max-width":"200px"},size:"small",onKeyup:Pe(R,["enter"]),onBlur:R},null,8,["modelValue","onKeyup"])):(h(),P(o,{key:1,class:"button-new-tag",size:"small",onClick:f},{default:s(()=>[L(" + New Tag ")]),_:1}))])}}});class vt{constructor(m){ie(this,"session");this.session=m}async sendMsg(m){const p=await this.session.post("/llm",{messages:m,user_id:null});return be.get(p,"data.result")}}const ft=new vt(Me),_t={class:"container"},bt={style:{height:"100%",position:"relative"}},gt=Q("div",{style:{width:"1px",height:"70px"}},null,-1),yt={style:{position:"absolute",left:"0",bottom:"10px",right:"0","z-index":"1000"}},Yt=pe({__name:"WorksEditPage",setup(T){const m=Oe(),p=it(),X=Ue(),V=I("history"),c=C({text:"",fileMeta:new ut,history:[{content:"Event start",timestamp:"2018-04-15"}],links:[{content:"Event start",timestamp:"2018-04-15"},{content:"Approved",timestamp:"2018-04-13"},{content:"Success",timestamp:"2018-04-11"}]}),A=C({works:[],directories:[]}),R=C([]),n=I(null),f=I(null),y=I([{cmd:u.ADD_FILE,icoName:"el-icon-delete",label:"新建Works"},{cmd:u.ADD_FOLDER,icoName:"el-icon-delete",label:"新建文件夹"},{cmd:u.DELETE,icoName:"el-icon-plus",label:"删除"},{cmd:u.RENAME,icoName:"el-icon-plus",label:"重命名"},{cmd:u.SETTING,icoName:"el-icon-plus",label:"设置"},{cmd:u.MOVE,icoName:"el-icon-plus",label:"移动"}]),z=I({searchType:"kw",searchTypes:[{label:"关键字",value:"kw"}],tags:[],orderKeys:[{label:"文件名",value:"fileName"},{label:"创建时间",value:"createTime"}]}),k=I(null),o=C({title:"新建文件",visible:!1,type:U.INPUT,value:void 0,currentStatus:u.NONE}),b=C({visible:!1,title:"title",content:"content"});I(!1);const d=C({visible:!1,tagInputValue:"",tagInputVisible:!1,tags:["标签一","标签二","标签三"],isPublic:!1,accessPassword:""}),ge=()=>{var t;f.value&&v.putArticleSetting((t=f.value)==null?void 0:t.id,void 0,d.tags,{isPublic:d.isPublic,accessPassword:d.accessPassword}).then(e=>{_.success("设置成功"),d.visible=!1,w()})},ye=(t,e,i)=>{switch(console.log(t,e,i),t){case u.ADD_FILE:k.value=t,o.title="新建Works",o.type=U.INPUT,o.visible=!0,n.value=e;break;case u.ADD_FOLDER:if(e!=null&&!e.isDir)return;k.value=t,o.title="新建文件夹",o.type=U.INPUT,o.visible=!0,n.value=e;break;case u.DELETE:k.value=t,o.title="删除文件"+e.fileName,o.type=U.CONFIRM,o.visible=!0,n.value=e;break;case u.RENAME:k.value=t,o.title="rename "+e.fileName,o.type=U.INPUT,o.visible=!0,n.value=e;break;case u.MOVE:k.value=t,o.currentStatus=t,o.title="移动到",o.type=U.SELECT_TREE,o.value=me([],A.directories),o.visible=!0;break;case u.SETTING:if(e!=null&&e.isDir)return;f.value=e,v.queryOne(e.id).then(r=>{var D,x;d.tagInputValue="",d.tags=r.tags??[],d.isPublic=be.toString((D=r.setting)==null?void 0:D.isPublic)=="true",d.accessPassword=((x=r.setting)==null?void 0:x.accessPassword)??"",d.visible=!0}).catch(r=>{_.error("获取设置失败")});break;case u.NODE_CLICK:e!=null&&!e.isDir?(n.value=e,se(e.id)):e||(n.value=null);break;case u.NODE_RIGHT_CLICK:e?f.value=e:f.value=null;break;default:n.value=null;break}},Ee=t=>{var e,i,r,D,x,K,Y,B,$,M,F,q,G,O,N,W;switch(console.log("dialog confirm",t,n.value,f.value,k.value),k.value){case u.ADD_FILE:if(!n.value)return;v.putArticle(t,"test",(e=n.value)==null?void 0:e.id).then(E=>{_.success("新建成功"),w()});break;case u.ADD_FOLDER:v.putDirectory((i=n.value)==null?void 0:i.id,t,[]).then(E=>{_.success("新建成功"),w()});break;case u.DELETE:if((r=n.value)!=null&&r.isDir)v.deleteDirectory((D=n.value)==null?void 0:D.id).then(E=>{_.success("删除成功"),w()});else{if(!n.value)return;v.deleteWorks((x=n.value)==null?void 0:x.id).then(E=>{_.success("删除成功"),w()})}break;case u.RENAME:(K=n.value)!=null&&K.isDir?v.moveDirectory((Y=n.value)==null?void 0:Y.id,(B=n.value)==null?void 0:B.parentId,t).then(E=>{_.success("重命名成功"),w()}):v.moveWorks(($=n.value)==null?void 0:$.id,(M=n.value)==null?void 0:M.parentId,t).then(E=>{_.success("重命名成功"),w()});break;case u.MOVE:if(t==((F=f.value)==null?void 0:F.parentId))return;(q=f.value)!=null&&q.isDir?v.moveDirectory((G=f.value)==null?void 0:G.id,t,(O=f.value)==null?void 0:O.fileName).then(E=>{_.success("移动成功"),w()}):v.moveWorks((N=f.value)==null?void 0:N.id,t,(W=f.value)==null?void 0:W.fileName).then(E=>{_.success("移动成功"),w()});break;default:return}},he=(t,e,i)=>{!e||!i||e.parentId==i||console.log(t,e,i)},Ve=()=>{c.fileMeta.id&&v.modifyArticle(c.fileMeta.id,c.text).then(t=>{_.success("保存成功"),se(c.fileMeta.id)})},ke=(t,e,i)=>{console.log(t,e,i),te.createFileMeta(void 0,void 0,void 0,void 0,void 0,i[0].size).then(r=>{if(!r)throw new Error("create file meta failed");te.uploadFile(r,i[0]).catch(D=>{_.error("上传失败"),te.deleteFile(r)}).then(()=>{e({url:Ke.cosUrlPrefix+"/"+r,desc:"图片描述"})})})},De=t=>{!t.id||!t.articleId||v.getHistory(t.articleId,t.id).then(e=>{var i;b.content=e.content,b.title=(i=c.fileMeta)==null?void 0:i.fileName,b.visible=!0})},Z=I(!1),ae=t=>{const{cmd:e}=t;switch(e){case j.HISTORY:Z.value=!0;break;case j.ROBOT:ee.value=!0;break}},w=()=>{v.listDirectoryAndWorks(null,!0).then(t=>{A.directories.splice(0,A.directories.length,...t.dirList),R.splice(0,R.length,...me(t.worksList,t.dirList))})},se=(t,e=!0,i=!0)=>{e&&v.queryOne(t).then(r=>{c.fileMeta=ct(r),c.text=r.content}),(e||i)&&v.listHistory(t).then(r=>{r.forEach(D=>{D.timestamp=Ye(D.createTime).format("YYYY-MM-DD HH:mm:ss")}),c.history=r})},ee=I(!1),g=C({inputVal:"",disableInput:!1,msgList:[]}),we=()=>{const t=g.inputVal.replace(/\s+/g,"");if(t.length==0)return;g.disableInput=!0;const e=[...g.msgList,{isRobot:!1,role:"user",content:t}];_.info("loading..."),ft.sendMsg(e).then(i=>{g.msgList.push({isRobot:!1,role:"user",content:t},{isRobot:!0,role:"robot",content:i}),g.inputVal=""}).catch(i=>{_.error(i)}).finally(()=>{g.disableInput=!1})},oe=()=>{m.switchPage([{eventArg:j.HISTORY,iconType:de.HISTORY},{eventArg:j.ROBOT,iconType:de.ROBOT}])};return ze(()=>{oe()}),Be(()=>{m.switchPage([])}),Fe(()=>{oe(),ne.on(re.NAV_BALL_CLICKED,ae),w()}),Ne(()=>{ne.on(re.NAV_BALL_CLICKED,ae)}),(t,e)=>{const i=ue("v-md-editor"),r=$e,D=qe,x=Ge,K=je,Y=Je,B=Qe,$=Xe,M=Ze,F=ue("v-md-preview"),q=et,G=tt,O=_e,N=fe,W=lt,E=at,Ie=st,Te=ot;return h(),H(J,null,[Q("div",_t,[a(rt,{class:"browser","original-fist-size":"20%","original-second-size":"80%"},{first:s(()=>[a(nt,{height:"100%",onCommand:ye,onMove:he,"content-menu-data":y.value,data:R,"search-data":z.value},null,8,["content-menu-data","data","search-data"])]),second:s(()=>[a(i,{onSave:Ve,onUploadImage:ke,modelValue:c.text,"onUpdate:modelValue":e[0]||(e[0]=l=>c.text=l),height:S(p).windowSize.height+"px","disabled-menus":[]},null,8,["modelValue","height"])]),_:1})]),a(dt,{title:o.title,value:o.value,visible:o.visible,"onUpdate:visible":e[1]||(e[1]=l=>o.visible=l),type:o.type,onConfirm:Ee},null,8,["title","value","visible","type"]),a(B,{style:{"z-index":"1100"},size:S(p).isPortrait?"70%":"40%",direction:S(p).isPortrait?"btt":"rtl",modelValue:Z.value,"onUpdate:modelValue":e[3]||(e[3]=l=>Z.value=l),"with-header":!1},{default:s(()=>[a(Y,{modelValue:V.value,"onUpdate:modelValue":e[2]||(e[2]=l=>V.value=l)},{default:s(()=>[a(K,{label:"历史记录",name:"history"},{default:s(()=>[a(x,null,{default:s(()=>[a(D,null,{default:s(()=>[(h(!0),H(J,null,le(c.history,(l,xe)=>(h(),P(r,{key:xe,timestamp:l.timestamp,onClick:Et=>De(l)},{default:s(()=>[L(ve(l.content),1)]),_:2},1032,["timestamp","onClick"]))),128))]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["size","direction","modelValue"]),a(B,{style:{"z-index":"10000"},size:S(p).isPortrait?"100%":"40%",direction:S(p).isPortrait?"btt":"ltr",modelValue:ee.value,"onUpdate:modelValue":e[6]||(e[6]=l=>ee.value=l),title:"聊天机器人"},{default:s(()=>[Q("div",bt,[a(x,null,{default:s(()=>[(h(!0),H(J,null,le(g.msgList,l=>(h(),P(G,{key:l.content},{default:s(()=>[l.isRobot?(h(),P(M,{key:0,span:3},{default:s(()=>[a($,{size:"large"},{default:s(()=>[L("Robot")]),_:1})]),_:1})):ce("",!0),a(M,{span:21,style:We({textAlign:l.isRobot?"left":"right",paddingLeft:l.isRobot?"5px":"",paddingRight:l.isRobot?"":"5px"})},{default:s(()=>[a(F,{style:{"padding-left":"0"},text:l.content},null,8,["text"])]),_:2},1032,["style"]),l.isRobot?ce("",!0):(h(),P(M,{key:1,span:3},{default:s(()=>[a(q,{size:"small",src:S(X).userInfo.avatar},null,8,["src"])]),_:1}))]),_:2},1024))),128)),gt]),_:1}),Q("div",yt,[a(N,{size:"large",modelValue:g.inputVal,"onUpdate:modelValue":e[5]||(e[5]=l=>g.inputVal=l),disabled:g.disableInput},He({append:s(()=>[a(O,{type:"primary",onClick:we},{default:s(()=>[L("Send")]),_:1})]),_:2},[g.inputVal?void 0:{name:"prepend",fn:s(()=>[a(O,{type:"primary",onClick:e[4]||(e[4]=l=>g.msgList.splice(0,g.msgList.length))},{default:s(()=>[L("Clear")]),_:1})]),key:"0"}]),1032,["modelValue","disabled"])])])]),_:1},8,["size","direction","modelValue"]),a(W,{modelValue:b.visible,"onUpdate:modelValue":e[7]||(e[7]=l=>b.visible=l),title:b.title},{default:s(()=>[a(F,{text:b.content},null,8,["text"])]),_:1},8,["modelValue","title"]),a(W,{modelValue:d.visible,"onUpdate:modelValue":e[11]||(e[11]=l=>d.visible=l),title:"设置"},{default:s(()=>[a(Te,{"label-position":"left","label-width":"100px",style:{"max-width":"460px"}},{default:s(()=>[a(E,{label:"标签"},{default:s(()=>[a(pt,{tags:d.tags,"onUpdate:tags":e[8]||(e[8]=l=>d.tags=l)},null,8,["tags"])]),_:1}),a(E,{label:"权限"},{default:s(()=>[a(Ie,{modelValue:d.isPublic,"onUpdate:modelValue":e[9]||(e[9]=l=>d.isPublic=l),size:"small","active-text":"公开","inactive-text":"私有"},null,8,["modelValue"])]),_:1}),a(E,{label:"访问密码"},{default:s(()=>[a(N,{disabled:d.isPublic,placeholder:"（为空表示不能用密码访问）",modelValue:d.accessPassword,"onUpdate:modelValue":e[10]||(e[10]=l=>d.accessPassword=l)},null,8,["disabled","modelValue"])]),_:1}),a(E,null,{default:s(()=>[a(O,{type:"primary",onClick:ge},{default:s(()=>[L("确认")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}}});export{Yt as default};
